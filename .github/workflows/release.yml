name: ğŸš€ Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.1.0, v1.0.1 gibi taglar
  workflow_dispatch:  # Manuel tetikleme

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore KesifUDFGenerator/KesifUDFGenerator.csproj
      
    - name: ğŸ—ï¸ Build Application
      run: dotnet build KesifUDFGenerator/KesifUDFGenerator.csproj --configuration Release --no-restore
      
    - name: ğŸ“‹ Test Application
      run: dotnet test KesifUDFGenerator/KesifUDFGenerator.csproj --configuration Release --no-build --verbosity normal
      continue-on-error: true  # Test yoksa devam et
      
    - name: ğŸ“¦ Publish Self-Contained
      run: |
        dotnet publish KesifUDFGenerator/KesifUDFGenerator.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish `
          -p:PublishSingleFile=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true
          
    - name: ğŸ“ Create Release Package
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { $matches[1] } else { "dev" }
        $packageName = "KesifMetniOlusturucu-$version-win-x64"
        
        # Ana exe dosyasÄ±nÄ± kopyala
        Copy-Item "./publish/KesifUDFGenerator.exe" "./$packageName.exe"
        
        # Ayarlar dosyasÄ±nÄ± kopyala
        if (Test-Path "./publish/appsettings.json") {
          Copy-Item "./publish/appsettings.json" "./appsettings.json"
        }
        
        # ZIP paketi oluÅŸtur
        Compress-Archive -Path "./$packageName.exe", "./appsettings.json" -DestinationPath "./$packageName.zip"
        
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: ğŸ“ Generate Release Notes
      run: |
        $releaseNotes = @"
        ## ğŸ‰ KeÅŸif Metni OluÅŸturucu ${{ env.VERSION }}
        
        ### ğŸ“‹ Bu SÃ¼rÃ¼mde:
        - âœ… Modern WPF arayÃ¼zÃ¼
        - âœ… Otomatik keÅŸif metni oluÅŸturma
        - âœ… BilirkiÅŸi tÃ¼rleri yÃ¶netimi
        - âœ… Ãœcret hesaplama sistemi
        - âœ… PDF kopyalama Ã¶zelliÄŸi
        - âœ… Ayarlanabilir varsayÄ±lan deÄŸerler
        
        ### ğŸ’» Sistem Gereksinimleri:
        - Windows 10/11 (x64)
        - .NET Runtime dahil (self-contained)
        
        ### ğŸ“¦ Kurulum:
        1. ``${{ env.PACKAGE_NAME }}.exe`` dosyasÄ±nÄ± indirin
        2. Ã‡alÄ±ÅŸtÄ±rÄ±n - kurulum gerektirmez!
        3. Ä°lk Ã§alÄ±ÅŸtÄ±rmada ayarlarÄ±nÄ±zÄ± yapÄ±landÄ±rÄ±n
        
        ### ğŸ”§ YapÄ±landÄ±rma:
        - ``appsettings.json`` dosyasÄ± ile Ã¶zelleÅŸtirilebilir
        - VarsayÄ±lan Ã¼cretler ayarlanabilir
        - BilirkiÅŸi tÃ¼rleri eklenebilir/dÃ¼zenlenebilir
        "@
        
        $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding UTF8
      shell: pwsh
      
    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "KeÅŸif Metni OluÅŸturucu ${{ env.VERSION }}"
        body_path: release-notes.md
        files: |
          ${{ env.PACKAGE_NAME }}.exe
          ${{ env.PACKAGE_NAME }}.zip
          appsettings.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
